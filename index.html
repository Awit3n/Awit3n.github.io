<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P File Share & Chat</title>
    <style>
        :root {
            --primary: #4a6fa5;
            --secondary: #6b8cbc;
            --light: #f5f7fa;
            --dark: #2c3e50;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 15px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--danger);
        }
        
        .status-dot.connected {
            background-color: var(--success);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .panel-title {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            color: var(--primary);
        }
        
        .file-drop-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .file-drop-area:hover, .file-drop-area.highlight {
            border-color: var(--primary);
            background-color: rgba(74, 111, 165, 0.05);
        }
        
        .file-input {
            display: none;
        }
        
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            background-color: var(--secondary);
        }
        
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .btn-success {
            background-color: var(--success);
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: var(--danger);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .file-info {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            display: none;
        }
        
        .file-info.show {
            display: block;
        }
        
        .file-info p {
            margin-bottom: 5px;
        }
        
        .file-name {
            font-weight: bold;
            word-break: break-all;
        }
        
        .file-size {
            color: #666;
        }
        
        .link-container {
            margin-top: 20px;
            display: none;
        }
        
        .link-container.show {
            display: block;
        }
        
        .link-box {
            display: flex;
            margin-top: 10px;
        }
        
        .link-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px 0 0 5px;
            font-size: 14px;
        }
        
        .copy-btn {
            border-radius: 0 5px 5px 0;
            padding: 10px 15px;
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 400px;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .message.received {
            background-color: #e9ecef;
            border-bottom-left-radius: 5px;
            align-self: flex-start;
        }
        
        .message.sent {
            background-color: var(--primary);
            color: white;
            border-bottom-right-radius: 5px;
            margin-left: auto;
        }
        
        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 5px;
            text-align: right;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }
        
        .chat-input:focus {
            border-color: var(--primary);
        }
        
        .send-btn {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .progress-container {
            margin-top: 15px;
            display: none;
        }
        
        .progress-container.show {
            display: block;
        }
        
        .progress-bar {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        
        .progress {
            height: 100%;
            background-color: var(--success);
            width: 0%;
            transition: width 0.3s;
        }
        
        .progress-text {
            text-align: center;
            font-size: 0.9rem;
            color: #666;
        }
        
        .instructions {
            margin-top: 30px;
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .instructions h3 {
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .instructions ol {
            margin-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 10px;
        }
        
        .alert {
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        
        .alert.show {
            display: block;
        }
        
        .alert-success {
            background-color: rgba(46, 204, 113, 0.2);
            border: 1px solid var(--success);
            color: #27ae60;
        }
        
        .alert-error {
            background-color: rgba(231, 76, 60, 0.2);
            border: 1px solid var(--danger);
            color: #c0392b;
        }
        
        .alert-info {
            background-color: rgba(52, 152, 219, 0.2);
            border: 1px solid #3498db;
            color: #2980b9;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>P2P File Share & Chat</h1>
            <p>Share files and chat directly between browsers with no server dependency</p>
        </header>
        
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Disconnected</span>
            </div>
            <div id="peerInfo"></div>
        </div>
        
        <div class="main-content">
            <div class="panel">
                <h2 class="panel-title">File Sharing</h2>
                
                <div id="senderSection">
                    <div class="file-drop-area" id="fileDropArea">
                        <p>Drag & drop a file here or click to browse</p>
                        <input type="file" id="fileInput" class="file-input">
                    </div>
                    
                    <div class="file-info" id="fileInfo">
                        <p class="file-name" id="fileName"></p>
                        <p class="file-size" id="fileSize"></p>
                    </div>
                    
                    <button id="generateLinkBtn" class="btn" disabled>
                        <span>Generate Share Link</span>
                    </button>
                    
                    <div class="link-container" id="linkContainer">
                        <p>Share this link with the receiver:</p>
                        <div class="link-box">
                            <input type="text" id="shareLink" class="link-input" readonly>
                            <button id="copyLinkBtn" class="btn copy-btn">Copy</button>
                        </div>
                    </div>
                </div>
                
                <div id="receiverSection" style="display: none;">
                    <div class="alert alert-info" id="receiverAlert">
                        Connected to sender. Ready to receive file.
                    </div>
                    
                    <div class="file-info" id="receivedFileInfo">
                        <p class="file-name" id="receivedFileName"></p>
                        <p class="file-size" id="receivedFileSize"></p>
                    </div>
                    
                    <button id="downloadBtn" class="btn btn-success" disabled>
                        <span>Download File</span>
                    </button>
                    
                    <div class="progress-container" id="progressContainer">
                        <div class="progress-bar">
                            <div class="progress" id="progressBar"></div>
                        </div>
                        <div class="progress-text" id="progressText">0%</div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h2 class="panel-title">Chat</h2>
                
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message received">
                            <div class="message-text">Welcome! Start a conversation once connected.</div>
                            <div class="message-time">System</div>
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Type a message..." disabled>
                        <button id="sendBtn" class="btn send-btn" disabled>
                            <span>➤</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3>How to use:</h3>
            <ol>
                <li><strong>Sender:</strong> Select a file and generate a share link</li>
                <li><strong>Sender:</strong> Share the link with the receiver</li>
                <li><strong>Receiver:</strong> Open the link to establish connection</li>
                <li><strong>Both:</strong> Use the chat while the file transfers</li>
                <li><strong>Receiver:</strong> Download the file once transfer is complete</li>
            </ol>
            <p><strong>Note:</strong> The sender's browser must remain open during the entire transfer process.</p>
        </div>
    </div>

    <!-- Include Simple-Peer library -->
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
    
    <script>
        // DOM Elements
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const peerInfo = document.getElementById('peerInfo');
        const fileDropArea = document.getElementById('fileDropArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const generateLinkBtn = document.getElementById('generateLinkBtn');
        const linkContainer = document.getElementById('linkContainer');
        const shareLink = document.getElementById('shareLink');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const senderSection = document.getElementById('senderSection');
        const receiverSection = document.getElementById('receiverSection');
        const receiverAlert = document.getElementById('receiverAlert');
        const receivedFileInfo = document.getElementById('receivedFileInfo');
        const receivedFileName = document.getElementById('receivedFileName');
        const receivedFileSize = document.getElementById('receivedFileSize');
        const downloadBtn = document.getElementById('downloadBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');

        // Application state
        let peer = null;
        let isInitiator = false;
        let selectedFile = null;
        let fileChunks = [];
        let receivedChunks = [];
        let fileHash = '';
        let connectionEstablished = false;

        // Initialize the application
        function init() {
            setupEventListeners();
            checkURLForOffer();
        }

        // Set up event listeners
        function setupEventListeners() {
            // File selection
            fileDropArea.addEventListener('click', () => fileInput.click());
            fileDropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileDropArea.classList.add('highlight');
            });
            fileDropArea.addEventListener('dragleave', () => {
                fileDropArea.classList.remove('highlight');
            });
            fileDropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileDropArea.classList.remove('highlight');
                if (e.dataTransfer.files.length) {
                    handleFileSelection(e.dataTransfer.files[0]);
                }
            });
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    handleFileSelection(e.target.files[0]);
                }
            });

            // Generate link button
            generateLinkBtn.addEventListener('click', generateShareLink);

            // Copy link button
            copyLinkBtn.addEventListener('click', copyShareLink);

            // Download button
            downloadBtn.addEventListener('click', downloadFile);

            // Chat functionality
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            sendBtn.addEventListener('click', sendMessage);
        }

        // Handle file selection
        function handleFileSelection(file) {
            selectedFile = file;
            
            // Display file info
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.classList.add('show');
            
            // Enable generate link button
            generateLinkBtn.disabled = false;
            
            // Calculate file hash
            calculateFileHash(file).then(hash => {
                fileHash = hash;
            });
        }

        // Format file size for display
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Calculate SHA-256 hash of a file
        async function calculateFileHash(file) {
            return new Promise((resolve) => {
                // For MVP, we'll use a simplified approach
                // In a production app, you would use the Web Crypto API
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Simplified hash calculation (not cryptographically secure)
                    // In a real implementation, use crypto.subtle.digest()
                    let hash = 0;
                    const arrayBuffer = e.target.result;
                    const uint8Array = new Uint8Array(arrayBuffer);
                    
                    for (let i = 0; i < uint8Array.length; i++) {
                        hash = ((hash << 5) - hash) + uint8Array[i];
                        hash |= 0; // Convert to 32-bit integer
                    }
                    
                    resolve(hash.toString(16));
                };
                reader.readAsArrayBuffer(file.slice(0, 1024)); // Only hash first 1KB for performance
            });
        }

        // Generate share link with WebRTC offer
        function generateShareLink() {
            if (!selectedFile) return;
            
            isInitiator = true;
            updateStatus('Connecting...', 'warning');
            
            // Create a new peer connection as initiator
            peer = new SimplePeer({
                initiator: true,
                trickle: false
            });
            
            setupPeerEvents();
            
            // When we have the signal data, create the share link
            peer.on('signal', (data) => {
                const offer = JSON.stringify(data);
                const encodedOffer = btoa(offer);
                
                // Create the shareable URL
                const url = new URL(window.location.href);
                url.searchParams.set('offer', encodedOffer);
                url.searchParams.set('filename', selectedFile.name);
                url.searchParams.set('filesize', selectedFile.size);
                url.searchParams.set('filehash', fileHash);
                
                shareLink.value = url.toString();
                linkContainer.classList.add('show');
                
                updateStatus('Waiting for receiver...', 'warning');
            });
        }

        // Copy share link to clipboard
        function copyShareLink() {
            shareLink.select();
            document.execCommand('copy');
            
            // Show feedback
            const originalText = copyLinkBtn.innerHTML;
            copyLinkBtn.innerHTML = '<span>Copied!</span>';
            setTimeout(() => {
                copyLinkBtn.innerHTML = originalText;
            }, 2000);
        }

        // Check URL for WebRTC offer (receiver side)
        function checkURLForOffer() {
            const urlParams = new URLSearchParams(window.location.search);
            const offerParam = urlParams.get('offer');
            
            if (offerParam) {
                // We're the receiver
                isInitiator = false;
                senderSection.style.display = 'none';
                receiverSection.style.display = 'block';
                receiverAlert.classList.add('show');
                
                const filename = urlParams.get('filename');
                const filesize = urlParams.get('filesize');
                const filehash = urlParams.get('filehash');
                
                receivedFileName.textContent = filename;
                receivedFileSize.textContent = formatFileSize(parseInt(filesize));
                receivedFileInfo.classList.add('show');
                
                // Create peer connection as receiver
                peer = new SimplePeer({
                    initiator: false,
                    trickle: false
                });
                
                setupPeerEvents();
                
                // Send the offer to the peer
                try {
                    const offer = JSON.parse(atob(offerParam));
                    peer.signal(offer);
                    updateStatus('Connecting to sender...', 'warning');
                } catch (error) {
                    console.error('Error parsing offer:', error);
                    updateStatus('Connection failed', 'error');
                }
            }
        }

        // Set up peer event handlers
        function setupPeerEvents() {
            peer.on('connect', () => {
                connectionEstablished = true;
                updateStatus('Connected', 'success');
                
                // Enable chat
                chatInput.disabled = false;
                sendBtn.disabled = false;
                
                // If we're the sender, prepare file for transfer
                if (isInitiator) {
                    prepareFileForTransfer();
                }
                
                // Add connection message to chat
                addChatMessage('Connection established. You can now chat.', 'system');
            });
            
            peer.on('data', (data) => {
                const message = JSON.parse(data.toString());
                handlePeerMessage(message);
            });
            
            peer.on('close', () => {
                connectionEstablished = false;
                updateStatus('Disconnected', 'error');
                
                // Disable chat
                chatInput.disabled = true;
                sendBtn.disabled = true;
                
                addChatMessage('Connection lost.', 'system');
            });
            
            peer.on('error', (err) => {
                console.error('Peer error:', err);
                updateStatus('Connection error', 'error');
            });
            
            // Handle incoming signals (for receiver)
            peer.on('signal', (data) => {
                if (!isInitiator && data.type === 'answer') {
                    // The receiver can send the answer back to the sender
                    // In a real implementation, you'd need a signaling server
                    // For this demo, we'll just log it
                    console.log('Answer generated:', data);
                }
            });
        }

        // Prepare file for transfer by splitting into chunks
        function prepareFileForTransfer() {
            if (!selectedFile) return;
            
            const CHUNK_SIZE = 16 * 1024; // 16KB chunks
            const totalChunks = Math.ceil(selectedFile.size / CHUNK_SIZE);
            fileChunks = [];
            
            let offset = 0;
            const fileReader = new FileReader();
            
            fileReader.onload = function(e) {
                const chunk = {
                    index: fileChunks.length,
                    data: e.target.result,
                    total: totalChunks
                };
                
                fileChunks.push(chunk);
                
                // Read next chunk if there are more
                offset += CHUNK_SIZE;
                if (offset < selectedFile.size) {
                    readNextChunk(offset, CHUNK_SIZE);
                } else {
                    // All chunks read, ready to send
                    console.log('All chunks prepared:', fileChunks.length);
                }
            };
            
            function readNextChunk(offset, size) {
                const slice = selectedFile.slice(offset, offset + size);
                fileReader.readAsArrayBuffer(slice);
            }
            
            // Start reading the first chunk
            readNextChunk(0, CHUNK_SIZE);
        }

        // Handle messages from the peer
        function handlePeerMessage(message) {
            switch (message.type) {
                case 'chat':
                    addChatMessage(message.text, 'received');
                    break;
                    
                case 'file_request':
                    // Sender receives file request from receiver
                    if (isInitiator) {
                        startFileTransfer();
                    }
                    break;
                    
                case 'file_chunk':
                    // Receiver receives file chunk from sender
                    if (!isInitiator) {
                        receiveFileChunk(message);
                    }
                    break;
                    
                case 'file_complete':
                    // Receiver receives file complete notification
                    if (!isInitiator) {
                        completeFileTransfer(message);
                    }
                    break;
            }
        }

        // Start file transfer (sender side)
        function startFileTransfer() {
            if (!fileChunks.length) return;
            
            let chunkIndex = 0;
            
            function sendNextChunk() {
                if (chunkIndex >= fileChunks.length) {
                    // All chunks sent
                    peer.send(JSON.stringify({
                        type: 'file_complete',
                        hash: fileHash,
                        filename: selectedFile.name
                    }));
                    return;
                }
                
                const chunk = fileChunks[chunkIndex];
                peer.send(JSON.stringify({
                    type: 'file_chunk',
                    ...chunk
                }));
                
                chunkIndex++;
                
                // Send next chunk after a small delay to avoid overwhelming the connection
                setTimeout(sendNextChunk, 10);
            }
            
            sendNextChunk();
        }

        // Receive file chunk (receiver side)
        function receiveFileChunk(message) {
            receivedChunks[message.index] = message.data;
            
            // Update progress
            const progress = Math.floor((Object.keys(receivedChunks).length / message.total) * 100);
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${progress}%`;
            
            if (!progressContainer.classList.contains('show')) {
                progressContainer.classList.add('show');
            }
            
            // If all chunks received, enable download
            if (Object.keys(receivedChunks).length === message.total) {
                downloadBtn.disabled = false;
            }
        }

        // Complete file transfer (receiver side)
        function completeFileTransfer(message) {
            // Verify file integrity (simplified)
            // In a real implementation, you would calculate the hash of the received file
            // and compare it to message.hash
            
            addChatMessage(`File "${message.filename}" received successfully.`, 'system');
            progressText.textContent = 'Transfer complete!';
        }

        // Download the received file
        function downloadFile() {
            if (!receivedChunks.length) return;
            
            // Reconstruct the file from chunks
            const blob = new Blob(receivedChunks);
            const url = URL.createObjectURL(blob);
            
            // Create download link
            const a = document.createElement('a');
            a.href = url;
            a.download = receivedFileName.textContent;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // Clean up
            URL.revokeObjectURL(url);
        }

        // Send chat message
        function sendMessage() {
            const text = chatInput.value.trim();
            if (!text || !connectionEstablished) return;
            
            // Send message to peer
            peer.send(JSON.stringify({
                type: 'chat',
                text: text
            }));
            
            // Add to local chat
            addChatMessage(text, 'sent');
            
            // Clear input
            chatInput.value = '';
        }

        // Add message to chat UI
        function addChatMessage(text, type) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            
            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            messageText.textContent = text;
            
            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            messageEl.appendChild(messageText);
            messageEl.appendChild(messageTime);
            
            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Update connection status
        function updateStatus(text, type) {
            statusText.textContent = text;
            
            // Update status dot color
            statusDot.className = 'status-dot';
            if (type === 'success') statusDot.classList.add('connected');
            
            // Update peer info
            if (connectionEstablished) {
                peerInfo.textContent = isInitiator ? 'Role: Sender' : 'Role: Receiver';
            } else {
                peerInfo.textContent = '';
            }
        }

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
