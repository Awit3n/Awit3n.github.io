<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>P2P File Transfer Button</title>
  <style>body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:18px;color:#111}button{margin:6px 0;padding:8px}</style>
  <script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
</head>
<body>
<h3>P2P File Transfer — avec bouton</h3>
<p>Émetteur : choisit un fichier et partage le lien. Destinataire : clique sur "Télécharger".</p>
<input id="fileinput" type="file" />
<div id="linkContainer" style="margin-top:12px"></div>
<div id="recvContainer" style="margin-top:12px"></div>
<script>
const CHUNK_SIZE = 64*1024;
let peer;
let file;
let fileHash;

function bufToHex(buffer){return Array.from(new Uint8Array(buffer)).map(b=>b.toString(16).padStart(2,'0')).join('')}
async function sha256(ab){const h = await crypto.subtle.digest('SHA-256', ab); return bufToHex(h)}

const fileInput = document.getElementById('fileinput');
const linkContainer = document.getElementById('linkContainer');
const recvContainer = document.getElementById('recvContainer');

fileInput.addEventListener('change', async e => {
  file = e.target.files[0];
  if(!file) return;
  const ab = await file.arrayBuffer();
  fileHash = await sha256(ab);
  peer = new SimplePeer({initiator:true,trickle:false});

  peer.on('signal', data => {
    const sdpB64 = btoa(JSON.stringify(data));
    const link = location.origin + location.pathname + '#offer=' + sdpB64;
    linkContainer.innerHTML = `<p>Lien à partager: <a href='${link}' target='_blank'>${link}</a></p>`;
    navigator.clipboard && navigator.clipboard.writeText(link).catch(()=>{});
  });

  peer.on('connect', async ()=>{
    const stream = file.stream();
    const reader = stream.getReader();
    let sent=0;
    while(true){
      const {value, done} = await reader.read();
      if(done) break;
      let offset=0;
      while(offset<value.byteLength){
        const slice = value.subarray(offset, offset+CHUNK_SIZE);
        peer.send(slice);
        offset += CHUNK_SIZE;
        sent += slice.byteLength;
      }
    }
    peer.send(JSON.stringify({type:'end', name:file.name, sha256:fileHash}));
  });
});

// Récepteur avec bouton
const params = new URLSearchParams(location.hash.replace('#','?'));
if(params.has('offer')){
  const offerB64 = params.get('offer');
  const offer = JSON.parse(atob(offerB64));
  peer = new SimplePeer({initiator:false,trickle:false});
  let buffers=[];
  let fileMeta = {};
  let downloadBtn;

  peer.on('signal', ans=>{console.log('Réponse prête')});

  peer.on('data', async d => {
    if(typeof d==='string'){ 
      try{
        const msg = JSON.parse(d);
        if(msg.type==='end'){
          const total = buffers.reduce((s,b)=>s+b.byteLength,0);
          const tmp = new Uint8Array(total); let off=0; for(const b of buffers){ tmp.set(new Uint8Array(b), off); off+=b.byteLength; }
          const blob = new Blob([tmp]);
          if(!downloadBtn){
            downloadBtn = document.createElement('button');
            downloadBtn.textContent = `Télécharger ${msg.name}`;
            downloadBtn.onclick = ()=>{
              const a = document.createElement('a');
              a.href = URL.createObjectURL(blob);
              a.download = msg.name;
              a.click();
            };
            recvContainer.appendChild(downloadBtn);
          }
          const hash = await sha256(tmp.buffer);
          const info = document.createElement('p');
          info.textContent = `Intégrité SHA256: ${hash===msg.sha256?'OK':'ÉCHEC'}`;
          recvContainer.appendChild(info);
        }
      } catch(e){}
    } else { buffers.push(d); }
  });
  peer.signal(offer);
}
</script>
</body>
</html>
