<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Cross-Machine FileShare</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #0d1f22;
            color: white;
        }
        .test-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .step {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
        }
        .step h3 {
            color: #16bf78;
            margin-bottom: 10px;
        }
        button {
            background: #16bf78;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #14a066;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background: rgba(22, 191, 120, 0.2); border: 1px solid #16bf78; }
        .warning { background: rgba(255, 193, 7, 0.2); border: 1px solid #ffc107; }
        .error { background: rgba(220, 53, 69, 0.2); border: 1px solid #dc3545; }
        .info { background: rgba(23, 162, 184, 0.2); border: 1px solid #17a2b8; }
        .test-file {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .instructions {
            background: rgba(22, 191, 120, 0.1);
            border: 1px solid rgba(22, 191, 120, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üåê Test Cross-Machine FileShare</h1>
        
        <div class="step">
            <h3>1. Test de compatibilit√© WebRTC</h3>
            <button onclick="testWebRTCCompatibility()">Tester WebRTC</button>
            <div id="webrtcStatus"></div>
        </div>
        
        <div class="step">
            <h3>2. Cr√©er un fichier de test volumineux</h3>
            <button onclick="createLargeTestFile()">Cr√©er fichier 15MB</button>
            <button onclick="createHugeTestFile()">Cr√©er fichier 50MB</button>
            <div id="fileStatus"></div>
        </div>
        
        <div class="step">
            <h3>3. Test de g√©n√©ration de lien cross-machine</h3>
            <input type="file" id="testFile" style="margin: 10px 0;">
            <button onclick="testCrossMachineLink()">Tester g√©n√©ration cross-machine</button>
            <div id="linkStatus"></div>
        </div>
        
        <div class="step">
            <h3>4. Simulation du processus complet</h3>
            <div class="instructions">
                <h4>üìã Instructions de test cross-machine :</h4>
                <ol>
                    <li><strong>Machine A (Exp√©diteur) :</strong>
                        <ul>
                            <li>Ouvrez FileShare dans un navigateur</li>
                            <li>S√©lectionnez un fichier > 10MB</li>
                            <li>G√©n√©rez le lien (contient <code>?cross=</code>)</li>
                            <li>Copiez le lien g√©n√©r√©</li>
                        </ul>
                    </li>
                    <li><strong>Machine B (Destinataire) :</strong>
                        <ul>
                            <li>Ouvrez le lien dans un autre navigateur</li>
                            <li>Une URL de r√©ponse sera g√©n√©r√©e</li>
                            <li>Copiez cette URL de r√©ponse</li>
                        </ul>
                    </li>
                    <li><strong>Retour Machine A :</strong>
                        <ul>
                            <li>Ouvrez l'URL de r√©ponse dans l'onglet de l'exp√©diteur</li>
                            <li>La connexion WebRTC s'√©tablit</li>
                            <li>Les fichiers sont transf√©r√©s</li>
                        </ul>
                    </li>
                </ol>
            </div>
        </div>
        
        <div class="step">
            <h3>5. Test de connectivit√© r√©seau</h3>
            <button onclick="testNetworkConnectivity()">Tester connectivit√©</button>
            <div id="networkStatus"></div>
        </div>
        
        <div class="step">
            <h3>6. Informations techniques</h3>
            <div id="techInfo"></div>
        </div>
        
        <div class="step">
            <h3>üìä R√©sultats attendus</h3>
            <div class="status info">
                <strong>‚úÖ Test r√©ussi si :</strong><br>
                ‚Ä¢ WebRTC support√© par le navigateur<br>
                ‚Ä¢ Fichier volumineux cr√©√© avec succ√®s<br>
                ‚Ä¢ Lien cross-machine g√©n√©r√© (contient <code>?cross=</code>)<br>
                ‚Ä¢ Connectivit√© r√©seau fonctionnelle<br>
                ‚Ä¢ Processus complet ex√©cut√© entre 2 machines
            </div>
            <div class="status error">
                <strong>‚ùå Test √©chou√© si :</strong><br>
                ‚Ä¢ WebRTC non support√©<br>
                ‚Ä¢ Erreur de g√©n√©ration de fichier<br>
                ‚Ä¢ Lien local g√©n√©r√© au lieu de cross-machine<br>
                ‚Ä¢ Probl√®me de connectivit√© r√©seau<br>
                ‚Ä¢ √âchec de connexion WebRTC
            </div>
        </div>
    </div>

    <script>
        let testFiles = [];
        
        function testWebRTCCompatibility() {
            const statusDiv = document.getElementById('webrtcStatus');
            
            const tests = {
                'RTCPeerConnection': typeof RTCPeerConnection !== 'undefined',
                'RTCDataChannel': typeof RTCDataChannel !== 'undefined',
                'getUserMedia': typeof navigator.mediaDevices !== 'undefined' && typeof navigator.mediaDevices.getUserMedia !== 'undefined',
                'HTTPS': location.protocol === 'https:' || location.hostname === 'localhost',
                'WebRTC': typeof window.RTCPeerConnection !== 'undefined'
            };
            
            let html = '<div class="status info">Tests WebRTC :<br>';
            let allSupported = true;
            
            for (const [test, supported] of Object.entries(tests)) {
                const status = supported ? '‚úÖ' : '‚ùå';
                const color = supported ? 'success' : 'error';
                html += `<div class="status ${color}">${status} ${test}</div>`;
                if (!supported) allSupported = false;
            }
            
            if (allSupported) {
                html += '<div class="status success">‚úÖ WebRTC enti√®rement support√©!</div>';
            } else {
                html += '<div class="status error">‚ùå WebRTC partiellement support√©</div>';
            }
            
            html += '</div>';
            statusDiv.innerHTML = html;
        }
        
        function createLargeTestFile() {
            createTestFile(15 * 1024 * 1024, 'test-large.txt');
        }
        
        function createHugeTestFile() {
            createTestFile(50 * 1024 * 1024, 'test-huge.txt');
        }
        
        function createTestFile(size, filename) {
            const statusDiv = document.getElementById('fileStatus');
            
            try {
                // Cr√©er un contenu de test
                const content = 'Test content '.repeat(Math.floor(size / 12));
                const blob = new Blob([content], { type: 'text/plain' });
                const file = new File([blob], filename, { type: 'text/plain' });
                
                testFiles = [file];
                
                statusDiv.innerHTML = `
                    <div class="status success">
                        ‚úÖ Fichier de test cr√©√©<br>
                        Nom: ${file.name}<br>
                        Taille: ${formatFileSize(file.size)}<br>
                        Type: ${file.type}
                    </div>
                `;
                
                // Mettre √† jour l'input file
                const fileInput = document.getElementById('testFile');
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;
                
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="status error">
                        ‚ùå Erreur lors de la cr√©ation du fichier<br>
                        ${error.message}
                    </div>
                `;
            }
        }
        
        function testCrossMachineLink() {
            const fileInput = document.getElementById('testFile');
            const statusDiv = document.getElementById('linkStatus');
            
            if (fileInput.files.length === 0) {
                statusDiv.innerHTML = '<div class="status warning">‚ö†Ô∏è S√©lectionnez d\'abord un fichier de test</div>';
                return;
            }
            
            const file = fileInput.files[0];
            const totalSize = file.size;
            const maxLocalSize = 10 * 1024 * 1024; // 10MB
            
            if (totalSize > maxLocalSize) {
                // Simuler la g√©n√©ration d'un lien cross-machine
                const roomId = 'test-cross-' + Math.random().toString(36).substr(2, 9);
                const testUrl = `${window.location.origin}/FileShare/?cross=${roomId}`;
                
                statusDiv.innerHTML = `
                    <div class="status success">
                        ‚úÖ Mode cross-machine d√©tect√©<br>
                        Fichier: ${file.name} (${formatFileSize(file.size)})<br>
                        Room ID: ${roomId}<br>
                        <textarea style="width: 100%; height: 60px; margin-top: 10px;">${testUrl}</textarea><br>
                        <button onclick="navigator.clipboard.writeText('${testUrl}')">Copier le lien</button>
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="status warning">
                        ‚ö†Ô∏è Fichier trop petit pour le mode cross-machine<br>
                        Taille: ${formatFileSize(file.size)}<br>
                        Limite: ${formatFileSize(maxLocalSize)}<br>
                        <small>Utilisez un fichier plus volumineux pour tester le mode cross-machine</small>
                    </div>
                `;
            }
        }
        
        function testNetworkConnectivity() {
            const statusDiv = document.getElementById('networkStatus');
            
            // Tester la connectivit√© aux serveurs STUN
            const stunServers = [
                'stun:stun.l.google.com:19302',
                'stun:stun1.l.google.com:19302'
            ];
            
            let html = '<div class="status info">Test de connectivit√© STUN :<br>';
            
            stunServers.forEach(server => {
                const pc = new RTCPeerConnection({
                    iceServers: [{ urls: server }]
                });
                
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        html += `<div class="status success">‚úÖ ${server} - Connect√©</div>`;
                    }
                };
                
                pc.onicegatheringstatechange = () => {
                    if (pc.iceGatheringState === 'complete') {
                        html += `<div class="status warning">‚ö†Ô∏è ${server} - Gathering termin√©</div>`;
                    }
                };
                
                // Timeout apr√®s 5 secondes
                setTimeout(() => {
                    pc.close();
                }, 5000);
            });
            
            html += '</div>';
            statusDiv.innerHTML = html;
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Test automatique au chargement
        window.addEventListener('load', () => {
            testWebRTCCompatibility();
            
            // Afficher les informations techniques
            const techInfo = document.getElementById('techInfo');
            techInfo.innerHTML = `
                <div class="status info">
                    <strong>Informations techniques :</strong><br>
                    ‚Ä¢ Navigateur: ${navigator.userAgent}<br>
                    ‚Ä¢ Protocole: ${location.protocol}<br>
                    ‚Ä¢ Host: ${location.hostname}<br>
                    ‚Ä¢ WebRTC: ${typeof RTCPeerConnection !== 'undefined' ? 'Support√©' : 'Non support√©'}<br>
                    ‚Ä¢ HTTPS: ${location.protocol === 'https:' ? 'Oui' : 'Non'}<br>
                    ‚Ä¢ Localhost: ${location.hostname === 'localhost' ? 'Oui' : 'Non'}
                </div>
            `;
        });
    </script>
</body>
</html>
